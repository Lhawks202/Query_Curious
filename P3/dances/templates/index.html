{% extends 'base.html' %}

{% block title %}Home{% endblock %}

{% block header %}
  <h1 class="display-4 mb-3">Dance Collection</h1>
  <p class="lead">Explore our collection of dances</p>
{% endblock %}

{% block content %}
  {% if request.args.get('search') %}
    <div class="mb-4 p-3 bg-primary bg-opacity-10 rounded">
      <h3><i class="bi bi-search me-2"></i>Search Results for: "{{ request.args.get('search') }}"</h3>
      <a href="{{ url_for('index') }}" class="btn btn-outline-primary btn-sm mt-2">
        <i class="bi bi-x-circle me-1"></i>Clear Search
      </a>
    </div>
  {% endif %}

  {% if dances %}
    <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
      {% for dance in dances %}
        <div class="col">
          <div class="card h-100 border-0 shadow-sm">
            {% if dance.Video %}
              <div class="ratio ratio-16x9">
                <iframe src="{{ dance.Video|replace('watch?v=', 'embed/') if 'youtube' in dance.Video else dance.Video }}" allowfullscreen></iframe>
              </div>
            {% else %}
              <div class="bg-primary bg-opacity-10 text-center p-5">
                <i class="bi bi-music-note-beamed" style="font-size: 4rem;"></i>
                <p class="mt-2">No Preview Available</p>
              </div>
            {% endif %}
            <div class="card-body">
              <h5 class="card-title">{{ dance.DanceName }}</h5>
              <p class="card-text"><i class="bi bi-music-note me-1"></i>{{ dance.StepName }}</p>
              {% if dance.Date %}
                <p class="card-text"><small class="text-muted"><i class="bi bi-calendar3 me-1"></i>Date: {{ dance.Date }}</small></p>
              {% endif %}
              {% if dance.Source %}
                <p class="card-text"><small class="text-muted"><i class="bi bi-book me-1"></i>Source: {{ dance.Source }}</small></p>
              {% endif %}
            </div>
            <div class="card-footer border-0 bg-transparent">
              <div class="btn-group w-100" role="group">
                {% if g.user %}
                  <button type="button"
                        class="btn btn-sm {% if dance.ID|string in user_learning %}btn-warning{% else %}btn-outline-warning{% endif %}"
                        data-dance-id="{{ dance.ID }}"
                        data-dance-name="{{ dance.DanceName }}"
                        data-is-learning="{{ 'true' if dance.ID|string in user_learning else 'false' }}"
                        data-role="learning-button"
                        onclick="handleLearningButtonClick(this)">
                    <i class="bi {% if dance.ID|string in user_learning %}bi-bookmark-check-fill{% else %}bi-bookmark-plus{% endif %} me-1"></i>
                    {% if dance.ID|string in user_learning %}Learning{% else %}Learn{% endif %}
                  </button>
        
                  <button type="button" 
                          class="btn btn-sm {% if dance.ID|string in user_favorites %}btn-danger{% else %}btn-outline-danger{% endif %}"
                          data-dance-id="{{ dance.ID }}"
                          data-dance-name="{{ dance.DanceName }}"
                          data-is-favorite="{{ 'true' if dance.ID|string in user_favorites else 'false' }}"
                          data-role="favorite-button"
                          onclick="handleFavoriteButtonClick(this)">
                    <i class="bi {% if dance.ID|string in user_favorites %}bi-heart-fill{% else %}bi-heart{% endif %} me-1"></i>
                    {% if dance.ID|string in user_favorites %}Favorited{% else %}Favorite{% endif %}
                  </button>
                {% endif %}
              </div>
            </div>
          </div>
        </div>
      {% endfor %}
    </div>
  {% else %}
  <div class="alert alert-info">
    <i class="bi bi-info-circle-fill me-2"></i>
    {% if request.args.get('search') %}
      No dances found matching "{{ request.args.get('search') }}".
    {% else %}
      No dances available. Check back later!
    {% endif %}
  {% endif %}

  <!-- Favorite Modal -->
<div class="modal fade" id="favoriteModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form id="favoriteFormElement">
        <div class="modal-header">
          <h5 class="modal-title">Add to Favorites</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="favoriteDanceId">
          <div class="mb-3">
            <label for="rating" class="form-label">What do you rate this dance?</label>
            <div class="star-rating d-flex justify-content-center mb-3">
              <input type="radio" id="star5" name="rating" value="5">
              <label for="star5" class="mx-1">â˜…</label>
            
              <input type="radio" id="star4" name="rating" value="4">
              <label for="star4" class="mx-1">â˜…</label>
            
              <input type="radio" id="star3" name="rating" value="3">
              <label for="star3" class="mx-1">â˜…</label>
            
              <input type="radio" id="star2" name="rating" value="2">
              <label for="star2" class="mx-1">â˜…</label>
            
              <input type="radio" id="star1" name="rating" value="1">
              <label for="star1" class="mx-1">â˜…</label>
            </div>
            <label for="date" class="form-label">Date</label>
            <input type="date" class="form-control" id="date" name="date" value="{{ current_date }}">
          </div>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-primary">Submit</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        </div>
      </form>
    </div>
  </div>
</div>

  <!-- Learning Modal -->
<div class="modal fade" id="learningModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form id="learningFormElement">
        <div class="modal-header">
          <h5 class="modal-title">Learn</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="learningDanceId">
          <div class="mb-3">
            <label for="date" class="form-label">What date did you start learning this dance?</label>
            <input type="date" class="form-control" id="date" name="date" value="{{ current_date }}">
          </div>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-primary">Submit</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        </div>
      </form>
    </div>
  </div>
</div>


{% endblock %}

{% block scripts %}


<script>
// Handle favorites

function handleFavoriteButtonClick(button) {
  const isFavorite = button.dataset.isFavorite === 'true';
  const danceId = button.dataset.danceId;
  const danceName = button.dataset.danceName;

  if (isFavorite) {
    // Immediate removal, no modal
    fetch('/favorites', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ danceId, action: 'remove' })
    })
    .then(res => res.json())
    .then(data => {
      if (data.status === 'removed') {
        updateFavoriteButton(button, false);
        alert(`You removed ${danceName} from Favorites`);
      } else {
        alert('Error: ' + data.message);
      }
    });
  } else {
    // Show modal to add
    const modal = new bootstrap.Modal(document.getElementById('favoriteModal'));
    document.getElementById('favoriteDanceId').value = danceId;
    modal.show();
  }
}

function updateFavoriteButton(button, hasFavorited) {
  button.dataset.isFavorite = hasFavorited ? 'true' : 'false';
  button.classList.toggle('btn-danger', hasFavorited);
  button.classList.toggle('btn-outline-danger', !hasFavorited);
  button.innerHTML = hasFavorited
    ? '<i class="bi bi-heart-fill me-1"></i>Favorited'
    : '<i class="bi bi-heart me-1"></i>Favorite';
}

document.getElementById('favoriteFormElement').addEventListener('submit', function(event) {
  event.preventDefault();
  const danceId = document.getElementById('favoriteDanceId').value;
  const date = document.getElementById('date').value;
  const rating = parseInt(document.querySelector('input[name="rating"]:checked')?.value, 10);
  console.log("rating: ", rating)
  const button = document.querySelector(`button[data-dance-id="${danceId}"][data-role="favorite-button"]`);
  const danceName = button.dataset.danceName;

  fetch('/favorites', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ rating, danceId, date, action: 'add' })
  })
  .then(res => res.json())
  .then(data => {
    if (data.status === 'added') {
      updateFavoriteButton(button, true);
      bootstrap.Modal.getInstance(document.getElementById('favoriteModal')).hide();
      alert(`${danceName} added to Favorites.`);
    } else {
      alert('Failed to add.');
    }
  });
});


// document.getElementById('favoriteModal').addEventListener('show.bs.modal', function (event) {
//   const button = event.relatedTarget; // â† the button that triggered the modal
//   const danceId = button.getAttribute('data-dance-id');
//   document.getElementById('favoriteDanceId').value = danceId;
//   document.querySelectorAll('input[name="rating"]').forEach(input => input.checked = false);
// });

//   document.getElementById('favoriteFormElement').addEventListener('submit', function(event) {
//   event.preventDefault();
//   const danceId = document.getElementById('favoriteDanceId').value;
//   const rating = parseInt(document.querySelector('input[name="rating"]:checked')?.value, 10);
//   const date = document.getElementById('date').value;

//   console.log("Dance ID:", danceId);

//   fetch(`/favorites`, {
//     method: 'POST',
//     headers: { 'Content-Type': 'application/json' },
//     body: JSON.stringify({ rating, date, danceId })
//   })
//   .then(res => res.json())
//   .then(data => {
//     alert('Dance favorited!');
//     console.log('Success:', data);
//     const modal = bootstrap.Modal.getInstance(document.getElementById('favoriteModal'));
//     modal.hide();  // close modal
//     const button = document.querySelector(`button[data-dance-id="${danceId.toString()}"][data-role="favorite-button"]`);
//     if (data.status === 'added') {
//         button.classList.remove('btn-outline-danger');
//         button.classList.add('btn-danger');
//         button.innerHTML = `<i class="bi bi-heart-fill me-1"></i>Favorited`;
//       } else {
//         button.classList.remove('btn-danger');
//         button.classList.add('btn-outline-danger');
//         button.innerHTML = `<i class="bi bi-heart me-1"></i>Favorite`;
//       }
//   })
//   .catch(error => {
//     console.error('Error:', error);
//     alert('Something went wrong.');
//   });
// });

//Handle learning
function handleLearningButtonClick(button) {
  const isLearning = button.dataset.isLearning === 'true';
  const danceId = button.dataset.danceId;
  const danceName = button.dataset.danceName;

  if (isLearning) {
    // ðŸ”¸ Immediate removal, no modal
    fetch('/learning', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ danceId, action: 'remove' })
    })
    .then(res => res.json())
    .then(data => {
      if (data.status === 'removed') {
        updateLearningButton(button, false);
        alert(`You removed ${danceName} from Learning`);
      } else {
        alert('Error: ' + data.message);
      }
    });
  } else {
    // ðŸ”¸ Show modal to add
    const modal = new bootstrap.Modal(document.getElementById('learningModal'));
    document.getElementById('learningDanceId').value = danceId;
    // document.getElementById('learningDanceName').textContent = danceName;
    modal.show();
  }
}

function updateLearningButton(button, isNowLearning) {
  button.dataset.isLearning = isNowLearning ? 'true' : 'false';
  button.classList.toggle('btn-warning', isNowLearning);
  button.classList.toggle('btn-outline-warning', !isNowLearning);
  button.innerHTML = isNowLearning
    ? '<i class="bi bi-bookmark-check-fill me-1"></i>Learning'
    : '<i class="bi bi-bookmark-plus me-1"></i>Learn';
}

document.getElementById('learningFormElement').addEventListener('submit', function(event) {
  event.preventDefault();
  const danceId = document.getElementById('learningDanceId').value;
  const date = document.getElementById('date').value;
  const button = document.querySelector(`button[data-dance-id="${danceId}"][data-role="learning-button"]`);
  const danceName = button.dataset.danceName;

  fetch('/learning', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ danceId, date, action: 'add' })
  })
  .then(res => res.json())
  .then(data => {
    if (data.status === 'added') {
      updateLearningButton(button, true);
      bootstrap.Modal.getInstance(document.getElementById('learningModal')).hide();
      alert(`${danceName} added to Learning.`);
    } else {
      alert('Failed to add.');
    }
  });
});


</script>
{% endblock %} 