{% extends 'base.html' %}

{% block header %}
  <h1 class="display-4 mb-3">Currently Learning Dances</h1>
  <p class="lead">All of your currently learning dances</p>
{% endblock %}

{% block content %}
    {% for learn in learning.values() %}
    <div class="col">
        <div class="card h-100 border-0 shadow-sm"
             style="cursor: pointer;"
             data-bs-toggle="modal"
             data-bs-target="#learnModal"
             data-dance-name="{{ learn['dance_name'] }}"
             data-step-list="{{ learn.step_list | join(', ') }}"
             data-date="{{ learn['date_added'] }}"
             data-step-figure-map='{{ learn["steps"] | default({}) | tojson | safe }}'
             onclick="populateLearningModal(this)">
          <div class="card-body">
            <h5 class="card-title">{{ learn['dance_name'] }}</h5>
            <p class="card-text">
              <small class="text-muted">
                <i class="bi bi-calendar3 me-1"></i>
                Date started learning: {{ learn['date_added'] }}
              </small>
            </p>
            <button type="button"
                    class="btn btn-sm btn-outline-danger mt-2"
                    data-dance-id="{{ learn['dance_id'] }}"
                    onclick="event.stopPropagation(); removeFromLearning(this)">
              <i class="bi bi-x-circle me-1"></i>Remove
            </button>
          </div>
        </div>
      </div>
      
        {% else %}
        <p>No learning dances found for this user. Go back to home and find a fun dance to learn!</p>
    {% endfor %}

    <div class="modal fade" id="learnModal" tabindex="-1" aria-labelledby="learnModalLabel" aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="learnModalLabel">Learning Dance Info</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <p><strong>Dance:</strong> <span id="modalLearnDanceName"></span></p>
              <p><strong>Step sequence:</strong> <span id="modalLearnStepList"></span></p>
              <div id="modalStepFigureList">
                <!-- Stepâ€“figure pairs will be inserted here dynamically -->
              </div>
            </div>
          </div>
        </div>
      </div>
      


<script>
    function populateLearningModal(card) {
      const danceName = card.getAttribute('data-dance-name');
      const stepList = card.getAttribute('data-step-list');
      const stepFigureData = JSON.parse(card.getAttribute('data-step-figure-map')); // embedded in data attribute

      document.getElementById('modalLearnDanceName').textContent = danceName;
      document.getElementById('modalLearnStepList').textContent = stepList;

      const container = document.getElementById('modalStepFigureList');
      container.innerHTML = ''; // clear previous content

      for (const [step, figures] of Object.entries(stepFigureData)) {
        const p = document.createElement('p');
        const strong = document.createElement('strong');
        strong.textContent = `${step}: `;
        p.appendChild(strong);
        p.append(figures.join(', '));
        container.appendChild(p);
      }
    }

    function removeFromLearning(button) {
        const danceId = button.getAttribute('data-dance-id');
        console.log("danceID: ", danceId)
    
        fetch('/learning', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ danceId, action: 'remove' })
        })
        .then(res => res.json())
        .then(data => {
            if (data.status === 'removed') {
                
                const card = button.closest('.col');
                if (card) card.remove();

                alert('Dance removed from Learning');
                location.reload();
            } else {
                alert('Error removing dance.');
            }
        })
        .catch(err => {
            console.error('Error:', err);
            alert('Request failed.');
        });
    }
    </script>
    {% endblock %}